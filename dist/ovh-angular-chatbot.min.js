/*! chatbot - 1.0.2 - 2017-08-22 */
"use strict";function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();angular.module("ovh-angular-chatbot",["ngEmbed","angular-web-notification","ngAnimate","ovh-angular-user-pref"]),angular.module("ovh-angular-chatbot",[]).run(["$templateCache",function(a){a.put("ovh-angular-chatbot-ngEmbed.template.html",'\x3c!--- SOURCE : https://github.com/ritz078/ng-embed#default-template --\x3e\x3c!--====== Main text with emoticons and link ============--\x3e<div ng-bind-html=neText></div>\x3c!--==========Video Embedding code (Youtube and vimeo)============--\x3e<div class=ne-video ng-if=video.host class=fade><div class=ne-video-preview ng-hide=nePlayVideo><div class=ne-video-thumb ng-click="nePlayVideo=!nePlayVideo"><img ng-src={{video.thumbnail}} alt=""> <i class="fa fa-play-circle-o"></i></div><div class=ne-video-detail><div class=ne-video-title><a ng-href={{video.url}}>{{video.title}}</a></div><div class=ne-video-desc>{{video.description}}</div><div class=ne-video-stats><span><i class="fa fa-eye"></i> {{video.views}}</span> <span><i class="fa fa-heart"></i> {{video.likes}}</span></div></div></div><div class=ne-video-player ng-if=nePlayVideo><iframe ng-src={{video.embedSrc}} frameborder=0 width={{video.width}} height={{video.height}} webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div></div>\x3c!--=====video player for mp4 and other html5 player supported videos==--\x3e<div class=ne-video ng-if=video.basic><div class=ne-video-player><div class=player><video ng-src={{video.basic}} controls></video></div></div></div>\x3c!--====== image preview code (gif|jpg|jpeg|tiff|png|svg|webp) =======--\x3e<div ng-init="neImageLong=false" ng-class="{false:\'ne-image\', true:\'ne-image ne-image-long\'}[neImageLong]" ng-if=image.url><div class=ne-image-wrapper><img ng-src={{image.url}} ng-click="neImageLong=!neImageLong" alt=""></div></div><div class=ne-pdf ng-if=pdf.url><div class=ne-pdf-preview ng-hide=neShowPdf><div class=ne-pdf-icon><i class="fa fa-file-pdf-o" aria-label=pdf></i></div><div class=ne-pdf-detail><div class=ne-pdf-title><a href={{pdf.url}}>{{pdf.url}}</a></div><div class=ne-pdf-view><button type=button><i class="fa fa-download" aria-hiden=true></i> <a ng-href={{pdf.url}} target=_blank title="Télécharger (Nouvelle fenêtre)">Télécharger</a></button> <button ng-click="neShowPdf=!neShowPdf" type=button><i class="fa fa-eye"></i> Voir PDF</button></div></div></div>\x3c!--====== pdf viewer =========--\x3e<div class=ne-pdf-viewer ng-if=neShowPdf><iframe ng-src={{pdf.url}} frameborder=0></iframe></div></div>\x3c!--===== audio player ===========--\x3e<div class=ne-audio ng-if=audio.url><audio ng-src={{audio.url}} controls></audio></div><div ng-if=tweets ng-repeat="tweet in tweets"><div ng-bind-html=tweet></div></div><div ng-if=videoServices class=ne-video ng-repeat="v in videoServices"><div class=ne-video-player><div class=player><div ng-bind-html=v></div></div></div></div><div ng-if=audioServices class=ne-audio ng-repeat="a in audioServices"><div ng-bind-html=a></div></div><div ng-if=codeServices class=ne-embed ng-repeat="c in codeServices"><div ng-bind-html=c></div></div><div ng-if=gist class=ne-gist ng-repeat="g in gist"><ne-gist id={{g}}></ne-gist></div>'),a.put("ovh-angular-chatbot-svg.template.html",'<div class=noDisplay><svg viewbox="0 0 32 32" id=chatbot-svg_bot><path class=chatbot-stroke_logo d=M26.5,5.5H8.5a5,5,0,0,0-5,5v11a6.29,6.29,0,0,1-3,5h3a3,3,0,0,0,1.87-.66,1.78,1.78,0,0,1,2.26,0,3,3,0,0,0,1.87.66h17a5,5,0,0,0,5-5v-11A5,5,0,0,0,26.5,5.5Z></path><path class=chatbot-stroke_logo d=M11.5,10.5h11a1,1,0,0,1,1,1v9a0,0,0,0,1,0,0h-13a0,0,0,0,1,0,0v-9A1,1,0,0,1,11.5,10.5Z></path><polyline class=chatbot-stroke_logo points="10.5 16.5 8.5 16.5 8.5 20.5 10.5 20.5"></polyline><line class=chatbot-stroke_logo x1=13.5 y1=17.5 x2=20.5 y2=17.5></line><polyline class=chatbot-stroke_logo points="23.5 20.5 25.5 20.5 25.5 16.5 23.5 16.5"></polyline><line class=chatbot-stroke_logo x1=14.5 y1=15.5 x2=14.5 y2=13.5></line><line class=chatbot-stroke_logo x1=19.5 y1=15.5 x2=19.5 y2=13.5></line></svg> <svg viewbox="0 0 20 20" id=chatbot-svg_bot_small><path class=chatbot-stroke_logo d=M16.5,3H5.5a3,3,0,0,0-3,3v7.5A3.91,3.91,0,0,1,.5,17h1a3,3,0,0,0,1.86-.66,1.76,1.76,0,0,1,2.24,0A3,3,0,0,0,7.51,17h9a3,3,0,0,0,3-3V6A3,3,0,0,0,16.5,3Z></path><path class=chatbot-stroke_logo d=M7.5,6h7a1,1,0,0,1,1,1v6a0,0,0,0,1,0,0h-9a0,0,0,0,1,0,0V7A1,1,0,0,1,7.5,6Z></path><polyline class=chatbot-stroke_logo points="15.5 13 16.5 13 16.5 10 15.5 10"></polyline><polyline class=chatbot-stroke_logo points="6.5 10 5.5 10 5.5 13 6.5 13"></polyline><line class=chatbot-stroke_logo x1=9.5 y1=11 x2=12.5 y2=11></line><line class=chatbot-stroke_logo x1=9.5 y1=9 x2=9.5 y2=8></line><line class=chatbot-stroke_logo x1=12.5 y1=9 x2=12.5 y2=8></line></svg> <svg viewbox="0 0 20 20" id=chatbot-svg_user><circle class=chatbot-stroke_logo cx=10 cy=4 r=3.5></circle><path class=chatbot-stroke_logo d=M15.5,16.2a5.5,5.5,0,1,0-11,0v3.3h11Z></path></svg> <svg viewbox="0 0 16 16" id=chatbot-svg_close><line class=chatbot-stroke_close x1=0.5 y1=0.5 x2=15.5 y2=15.5></line><line class=chatbot-stroke_close x1=15.5 y1=0.5 x2=0.5 y2=15.5></line></svg> <svg viewbox="0 0 16 16" id=chatbot-svg_back><polyline class=chatbot-stroke_close points="12.5 15.5 3.5 8 12.5 0.5"></polyline></svg> <svg viewbox="0 0 18 20" id=chatbot-svg_paperplane><polygon class=chatbot-stroke_logo points="12.5 19.5 5.5 12.5 17.5 0.5 12.5 19.5"></polygon><polyline class=chatbot-stroke_logo points="5.5 12.5 0.5 7.5 17.5 0.5"></polyline><polyline class=chatbot-stroke_logo points="8.5 15.5 5.5 17.5 5.5 12.5"></polyline></svg></div>'),a.put("ovh-angular-chatbot.template.html",'<div id=ovh-angular-chatbot><ng-include src="\'ovh-angular-chatbot-svg.template.html\'"></ng-include><div class=chatbot-main ng-hide=ctrl.hidden ng-if=ctrl.options.enable><div class=chatbot-header><h6 class="chatbot-title oui-header_6" ng-hide=ctrl.hidden><span class=chatbot-back ng-click=ctrl.close()><svg viewbox="0 0 16 16"><use href=#chatbot-svg_back></use></svg></span> <span class=chatbot-icon aria-hidden=true><svg viewbox="0 0 32 32"><use href=#chatbot-svg_bot></use></svg></span> Assistance Virtuelle</h6><span class=chatbot-close aria-label=Fermer ng-click=ctrl.close() ng-hide=ctrl.hidden><svg viewbox="0 0 16 16"><use href=#chatbot-svg_close></use></svg></span></div><hr class="chatbot-line chatbot-header-line" ng-hide=ctrl.hidden><div class=chatbot-body><div class=chatbot-messages ng-hide=ctrl.hidden><div ng-repeat="msg in ctrl.messages track by $index" ng-if="msg.type !== ctrl.MESSAGE_TYPES.postback" ng-class="{\'chatbot-right\': msg.type === ctrl.MESSAGE_TYPES.user, \'chatbot-left\': msg.type !== ctrl.MESSAGE_TYPES.user};"><div ng-if="msg.type !== ctrl.MESSAGE_TYPES.user" class="chatbot-pp chatbot-pp_bot"><svg viewbox="0 0 20 20" class="chatbot-icon chatbot-icon_pp"><use href=#chatbot-svg_bot_small></use></svg></div><div class="oui-message oui-message_no-icon chatbot-message" ng-class="{\'chatbot-user\': msg.type === ctrl.MESSAGE_TYPES.user, \'chatbot-bot\': msg.type !== ctrl.MESSAGE_TYPES.user};" id="chat-message-{{ctrl.messages.length - $index}}"><span class=chatbot-tip ng-class="{\'oui-tip-left\': msg.type === ctrl.MESSAGE_TYPES.user, \'oui-tip-right\': msg.type !== ctrl.MESSAGE_TYPES.user};" aria-hidden=true></span><div class=oui-message__body><div ng-class="{\'chatbot-userText\': msg.type === ctrl.MESSAGE_TYPES.user, \'chatbot-botText\': msg.type === ctrl.MESSAGE_TYPES.bot};"><span ng-if="msg.type === ctrl.MESSAGE_TYPES.bot" class=chatbot-textBold>Assistant virtuel OVH</span> <span ng-if="msg.type === ctrl.MESSAGE_TYPES.user" class=chatbot-textBold>vous</span><ng-embed class=oui-paragraph ng-repeat="txt in msg.message.split(\'\\n\') track by $index" embed-data=txt embed-template-url=ovh-angular-chatbot-ngEmbed.template.html embed-options=ctrl.NG_EMBED_OPTIONS></ng-embed><div ng-repeat="item in msg.items track by $index" class=chatbot-item><div class=chatbot-item_title>{{item.title}}</div><ng-embed class="chatbot-item_text oui-paragraph" ng-repeat="itemTxt in item.text.split(\'\\n\') track by $index" embed-data=itemTxt embed-template-url=ovh-angular-chatbot-ngEmbed.template.html embed-options=ctrl.NG_EMBED_OPTIONS></ng-embed></div><div class="chatbot-list oui-list"><ul class=oui-list__items><li class="oui-list__item chatbot-button" ng-repeat="button in msg.buttons track by $index"><button class="oui-button oui-button_secondary" type=button value={{button.value}} ng-click=ctrl.buttonClick(button)>{{button.text}}</button></li></ul></div></div></div></div><div ng-if="msg.type === ctrl.MESSAGE_TYPES.user" class="chatbot-pp chatbot-pp_user"><svg viewbox="0 0 20 20" class="chatbot-icon chatbot-icon_pp"><use href=#chatbot-svg_user></use></svg></div></div></div><div ng-show="ctrl.processing && !ctrl.hidden" class="chatbot-msgBox oui-message oui-message_info"><p class="oui-paragraph oui-message__body">Traitement en cours</p><div class="oui-loader oui-loader_s"><div class=oui-loader__container><div class=oui-loader__image></div></div></div></div><div ng-show="ctrl.error && !ctrl.hidden" class="chatbot-msgBox oui-message oui-message_error"><button class="oui-icon oui-icon-close oui-message__close-button" aria-hidden=true type=button ng-click="ctrl.error = null;"></button><p class="oui-paragraph oui-message__body">Une erreur s\'est produite, merci de réessayer ultérieurement.</p></div><hr class=chatbot-line ng-hide=ctrl.hidden><div class=chatbot-user-input ng-hide=ctrl.hidden><div class="chatbot-input-group oui-input-group"><input class="chatbot-input oui-input" name=message ng-model=ctrl.message autofocus ng-keyup="$event.keyCode == 13 && ctrl.ask()" ng-disabled=!ctrl.messages.length placeholder="Votre message..." autofocus> <button class="chatbot-button oui-button oui-button_primary" type=button ng-click=ctrl.ask() ng-disabled="!ctrl.messages.length || !ctrl.message.length"><svg viewbox="0 0 18 20" class=chatbot-send-button><use href=#chatbot-svg_paperplane></use></svg></button></div></div></div></div><div class="chatbot-msgBox_init oui-message oui-message_error" ng-if="ctrl.initialized && ctrl.error && !ctrl.messages.length"><button type=button class="oui-icon oui-icon-close oui-message__close-button" aria-hidden=true ng-click="ctrl.error = null; ctrl.initialized = false"></button><p class="oui-paragraph oui-message__body">Impossible de démarrer le chatbot. Veuillez essayer plus tard</p></div><div class=chatbot-open ng-hide="!ctrl.hidden || (ctrl.error && !ctrl.messages.length)" ng-if=ctrl.options.enable><span class="chatbot-notification oui-paragraph" aria-hidden=true ng-hide=!ctrl.newMsg>{{ctrl.newMsg > 9 ? \'+\' : ctrl.newMsg}}</span><div class="oui-loader oui-loader_s" ng-if="!ctrl.messages.length && ctrl.initialized && !ctrl.error"><div class="oui-loader__container chatbot-loader"><div class=oui-loader__image></div></div></div><button class=chatbot-icon_wrapper ng-show="ctrl.messages.length || !ctrl.initialized" ng-click=ctrl.open() type=button><div class=chatbot-icon aria-hidden=true><svg viewbox="0 0 32 32"><use href=#chatbot-svg_bot></use></svg></div></button></div></div>')}]),angular.module("ovh-angular-chatbot").constant("CHATBOT_MESSAGE_TYPES",{bot:"bot",user:"user",postback:"postback"}).constant("CHATBOT_NGEMBED_OPTIONS",{watchEmbedData:!0,sanitizeHtml:!0,fontSmiley:!0,emoji:!0,link:!0,linkTarget:"_blank",pdf:{embed:!0},image:{embed:!0},audio:{embed:!0},basicVideo:!0,gdevAuth:"",video:{embed:!1,width:360,height:240,ytTheme:"dark",details:!1,thumbnailQuality:"medium",autoPlay:!1},twitchtvEmbed:!0,dailymotionEmbed:!0,tedEmbed:!0,dotsubEmbed:!0,liveleakEmbed:!0,ustreamEmbed:!0,soundCloudEmbed:!0,soundCloudOptions:{height:160,themeColor:"f50000",autoPlay:!1,hideRelated:!1,showComments:!0,showUser:!0,showReposts:!1,visual:!1,download:!1},spotifyEmbed:!0,tweetEmbed:!1,tweetOptions:{maxWidth:550,hideMedia:!1,hideThread:!1,align:"none",lang:"en"},code:{highlight:!1,lineNumbers:!1},codepenEmbed:!0,codepenHeight:300,jsfiddleEmbed:!0,jsfiddleHeight:300,jsbinEmbed:!0,jsbinHeight:300,plunkerEmbed:!0,githubgistEmbed:!0,ideoneEmbed:!0,ideoneHeight:300});var ChatbotCtrl=function(){function a(b,c,d,e,f,g,h,i){var j=this;_classCallCheck(this,a),this.$interval=b,this.$window=c,this.webNotification=e,this.chatbotService=g,this.$translate=d,this.error=!1,this.initialized=!1,this.hidden=!0,this.processing=!1,this.newMsg=0,this.MESSAGE_TYPES=h,this.NG_EMBED_OPTIONS=i;var k=[];Object.defineProperty(this,"messages",{set:function(a){var b=k.length;k=a,k.length&&this.update(k.length-b)},get:function(){return k}}),this.messages=[],this.options={notifications:!1,enable:!1},this.errorHandler=this.errorHandler.bind(this),this.formatMsg=this.formatMsg.bind(this),this.tick=this.tick.bind(this),f.getValue("CHATBOT_PREF").then(function(a){Object.assign(j.options,a)}).catch(function(){return f.assign("CHATBOT_PREF",j.options)})}return a.$inject=["$interval","$window","$translate","webNotification","ovhUserPref","chatbotService","CHATBOT_MESSAGE_TYPES","CHATBOT_NGEMBED_OPTIONS"],_createClass(a,[{key:"formatMsg",value:function(a){var b={message:a.message,items:a.items,buttons:a.buttons.map(function(a){return{text:a.text,value:a.value,externalUrl:"web_url"===a.type}})};switch(a.origin){case"user":b.type=this.MESSAGE_TYPES.user;break;case"user_postback":b.type=this.MESSAGE_TYPES.postback;break;case"bot":b.type=this.MESSAGE_TYPES.bot}return b}},{key:"ask",value:function(){var a=this;if(this.message){this.$interval.cancel(this.tickInterval),this.error=null,this.processing=!0,this.chatbotService.post(this.message).then(function(b){a.messages=[].concat(_toConsumableArray(a.messages),_toConsumableArray(b.data.map(a.formatMsg))),a.tickInterval||(a.tickInterval=a.$interval(a.tick,1e3*a.pullRate)),a.processing=!1}).catch(this.errorHandler);var b={type:this.MESSAGE_TYPES.user,message:this.message,items:[],buttons:[]};this.message="",this.messages=[].concat(_toConsumableArray(this.messages),[b])}}},{key:"buttonClick",value:function(a){var b=this;a.externalUrl?this.$window.open(a.value):(this.error=null,this.processing=!0,this.chatbotService.post(a.value,"postback").then(function(a){b.messages=[].concat(_toConsumableArray(b.messages),_toConsumableArray(a.data.map(b.formatMsg))),b.processing=!1}).catch(this.errorHandler))}},{key:"close",value:function(){this.hidden=!0}},{key:"open",value:function(){return this.initialized?this.messages.length?(this.hidden=!1,this.newMsg=0,null):null:this.init()}},{key:"errorHandler",value:function(){this.$interval.cancel(this.tickInterval),this.error=!0,this.processing=!1}},{key:"tick",value:function(){var b=this;this.chatbotService.history().then(function(c){var d=c.data.map(b.formatMsg),e=a.extractDifferenceBetweenArrays(b.messages,d);b.messages=[].concat(_toConsumableArray(b.messages),_toConsumableArray(e))}).catch(this.errorHandler)}},{key:"init",value:function(){var a=this;this.options.enable&&(this.initialized=!0,this.chatbotService.history().then(function(b){a.messages=b.data.map(a.formatMsg),a.$interval.cancel(a.tickInterval),a.tickInterval=a.$interval(a.tick,1e3*a.pullRate),a.open()}).catch(this.errorHandler))}},{key:"update",value:function(a){var b=this;this.hidden&&a>0&&(this.newMsg+=a,this.options.notifications&&this.$translate("chatbot_title").then(function(a){b.webNotification.showNotification(a,{body:b.messages[b.messages.length-1].message,onClick:b.open,icon:"img/ovh-angular-chatbot.png",autoClose:4e3})}))}}],[{key:"areMessagesEquals",value:function(a,b){return null!=a&&null!=b&&a.message===b.message}},{key:"extractDifferenceBetweenArrays",value:function(b,c){for(var d=b.length-1,e=c.length-1;e>=0;e--)if(a.areMessagesEquals(c[e],b[d]))return c.slice(e+1,c.length);return c}}]),a}();angular.module("ovh-angular-chatbot").controller("chatbotController",ChatbotCtrl),angular.module("ovh-angular-chatbot").directive("chatbot",function(){return{templateUrl:"ovh-angular-chatbot.template.html",restrict:"E",replace:!0,controller:"chatbotController",controllerAs:"ctrl",bindTocontroller:!0,link:function(a,b,c,d){d.pullRate=2,c.pull&&Number.isInteger(parseInt(c.pull,10))&&(d.pullRate=parseInt(c.pull,10)),b.draggable({handle:".chatbot-header",cursor:"move",containment:"window"}),a.$watch(function(){return d.options.enable?b.find(".chatbot-messages")[0].scrollHeight:0},function(a){return b.find(".chatbot-messages").scrollTop(a)}),a.$watch(d.hidden,function(a){return a?null:b.find("input.chatbot-input").focus()})}}});var ChatbotServiceProvider=function(){function a(){_classCallCheck(this,a);var b=this;this.chatbotUrl="/engine/2api/chatbot",this.$get=["$http","$q",function(a,c){var d={};return d.post=function(d,e){return c(function(c,f){return a({method:"POST",url:b.chatbotUrl,data:{message:d,type:e||"message"},serviceType:"aapi",withCredentials:!0}).then(c,f)})},d.history=function(){return c(function(c,d){return a({method:"GET",url:b.chatbotUrl,serviceType:"aapi",withCredentials:!0}).then(c,d)})},d}]}return _createClass(a,[{key:"setChatbotUrl",value:function(a){this.chatbotUrl=a}},{key:"getChatbotUrl",value:function(){return this.chatbotUrl}}]),a}();angular.module("ovh-angular-chatbot").provider("chatbotService",ChatbotServiceProvider);